<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arma FCS Map (LAN)</title>
  <style>
    html, body { height: 100%; margin:0; background:#0d0f12; color:#e6e6e6; font-family: system-ui, sans-serif; }
    #top { padding:10px; border-bottom:1px solid #2a2f36; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn, input, select { background:#13181f; color:#e6e6e6; border:1px solid #2a2f36; border-radius:6px; padding:8px; }
    #mapWrap { position:relative; width:100%; height:calc(100% - 76px); overflow:auto; }
    #mapImg { position:absolute; top:0; left:0; transform-origin: top left; }
    #overlay { position:absolute; top:0; left:0; pointer-events:none; }
    .pill { padding:6px 10px; border:1px solid #2a2f36; border-radius:999px; }
  </style>
</head>
<body>
<div id="top">
  <input id="imgfile" type="file" accept="image/*" class="btn" />
  <select id="mode"><option value="cal">ĞšĞĞ›Ğ˜Ğ‘Ğ ĞĞ’ĞšĞ</option><option value="mission">ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯</option></select>
  <input id="x0" placeholder="P0 X" style="width:90px" />
  <input id="y0" placeholder="P0 Y" style="width:90px" />
  <input id="dist" value="1000" style="width:90px" title="Ğ”Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ P1-P2 Ğ¼"/>
  <select id="dest"><option value="target">ğŸ¯ Ğ¦ĞµĞ»ÑŒ</option><option value="observer">ğŸ‘ï¸ ĞĞ°Ğ±Ğ»ÑĞ´Ğ°Ñ‚ĞµĞ»ÑŒ</option><option value="drone">ğŸ›¸ Ğ”Ñ€Ğ¾Ğ½</option><option value="gun1">ğŸ’¥ gun1</option><option value="gun2">ğŸ’¥ gun2</option><option value="gun3">ğŸ’¥ gun3</option><option value="gun4">ğŸ’¥ gun4</option><option value="gun5">ğŸ’¥ gun5</option></select>
  <button id="save" class="btn">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºÑƒ</button>
  <button id="clear" class="btn">Ğ¡Ğ±Ñ€Ğ¾Ñ</button>
  <span class="pill" id="status">ĞšĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ°: Ğ½ĞµÑ‚</span>
</div>
<div id="mapWrap">
  <img id="mapImg" alt="map" />
  <svg id="overlay"></svg>
</div>
<script>
const $=id=>document.getElementById(id);
const st={img:null,w:0,h:0,p0:null,p1:null,p2:null,calOk:false,markers:new Map(),nfa:[]};
const colors={target:'#ff5555',observer:'#88ccff',drone:'#f5d742',gun1:'#55ff99',gun2:'#55ff99',gun3:'#55ff99',gun4:'#55ff99',gun5:'#55ff99'};
async function post(url,obj){try{await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});}catch(e){}}
async function getJson(url){try{return await (await fetch(url)).json();}catch(e){return null;}}
function setStatus(t){$('status').textContent=t;}
function reset(){st.p0=st.p1=st.p2=null;st.calOk=false;st.markers.clear();draw();setStatus('ĞšĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ°: Ğ½ĞµÑ‚');post('/api/cal_status',{ok:false,details:'reset'});}
function draw(){
  const svg=$('overlay'); svg.innerHTML=''; svg.setAttribute('width',st.w); svg.setAttribute('height',st.h);
  for (const [k,m] of st.markers){const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',m.x); c.setAttribute('cy',m.y); c.setAttribute('r',8); c.setAttribute('fill',colors[k]||'#ddd'); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','1');
    const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',m.x+10); t.setAttribute('y',m.y-10); t.setAttribute('fill','#fff'); t.textContent=k;
    g.append(c,t); svg.append(g);
  }
  for (const n of st.nfa){
    if(!st.calOk) continue;
    const p=worldToPixel(n.x_m,n.y_m); if(!p) continue;
    const r=n.radius_m/pixelsToMeters();
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',r); c.setAttribute('fill','rgba(255,80,80,.15)'); c.setAttribute('stroke','#ff6666'); c.setAttribute('stroke-width','2');
    svg.append(c);
  }
  ['p0','p1','p2'].forEach((k,i)=>{const p=st[k]; if(!p)return; const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',6); c.setAttribute('fill',['#fff','#8f8','#88f'][i]); svg.append(c);});
}
function pixelsToMeters(){ if(!st.p1||!st.p2) return 1; const d=Math.hypot(st.p2.x-st.p1.x,st.p2.y-st.p1.y); return Number($('dist').value||1000)/Math.max(1,d); }
function pixelToWorld(px,py){ if(!st.calOk) return null; const x0=Number($('x0').value||0),y0=Number($('y0').value||0); const mpp=pixelsToMeters(); const ux=(st.p2.x-st.p1.x)/Math.hypot(st.p2.x-st.p1.x,st.p2.y-st.p1.y); const uy=(st.p2.y-st.p1.y)/Math.hypot(st.p2.x-st.p1.x,st.p2.y-st.p1.y); const wx=px-st.p1.x, wy=py-st.p1.y; const lx=(wx*ux+wy*uy)*mpp; const ly=(-wx*uy+wy*ux)*mpp; const l0x=((st.p0.x-st.p1.x)*ux+(st.p0.y-st.p1.y)*uy)*mpp; const l0y=(-(st.p0.x-st.p1.x)*uy+(st.p0.y-st.p1.y)*ux)*mpp; return {x_m:x0+(lx-l0x),y_m:y0+(ly-l0y)}; }
function worldToPixel(xm,ym){ if(!st.calOk) return null; const x0=Number($('x0').value||0),y0=Number($('y0').value||0); const mpp=pixelsToMeters(); const ux=(st.p2.x-st.p1.x)/Math.hypot(st.p2.x-st.p1.x,st.p2.y-st.p1.y); const uy=(st.p2.y-st.p1.y)/Math.hypot(st.p2.x-st.p1.x,st.p2.y-st.p1.y); const l0x=((st.p0.x-st.p1.x)*ux+(st.p0.y-st.p1.y)*uy)*mpp; const l0y=(-(st.p0.x-st.p1.x)*uy+(st.p0.y-st.p1.y)*ux)*mpp; const tx=(xm-x0)+l0x, ty=(ym-y0)+l0y; const px=tx/mpp, py=ty/mpp; return {x:st.p1.x + px*ux - py*uy, y:st.p1.y + px*uy + py*ux}; }
$('imgfile').onchange=(e)=>{const f=e.target.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); const img=$('mapImg'); img.onload=()=>{st.w=img.naturalWidth;st.h=img.naturalHeight;$('overlay').style.width=st.w+'px';$('overlay').style.height=st.h+'px';reset();}; img.src=url;};
$('mapWrap').onclick=async(e)=>{ const img=$('mapImg'); if(!img.src) return; const rect=img.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top; if(x<0||y<0||x>st.w||y>st.h) return; if($('mode').value==='cal'){ if(!st.p0) st.p0={x,y}; else if(!st.p1) st.p1={x,y}; else st.p2={x,y}; st.calOk=Boolean(st.p0&&st.p1&&st.p2); if(st.calOk) setStatus('ĞšĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ°: OK'); draw(); return; } if(!st.calOk) return; const dest=$('dest').value; st.markers.set(dest,{x,y}); const xy=pixelToWorld(x,y); if(xy){ await post('/api/set_point',{dest,x_m:xy.x_m,y_m:xy.y_m,label:dest}); await post('/api/click',{x_m:xy.x_m,y_m:xy.y_m,dest,note:dest}); } draw(); };
$('clear').onclick=reset;
$('save').onclick=async()=>{ if(!st.calOk) return; await post('/api/cal_status',{ok:true,details:'saved'}); setStatus('ĞšĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ°: OK (saved)'); };
async function sync(){ const res=await getJson('/api/state'); if(!res||!res.ok) return; st.nfa=Array.isArray(res.nfa_zones)?res.nfa_zones:[]; for(const [d,p] of Object.entries(res.points||{})){ if(typeof p.x_m!=='number') continue; const pp=worldToPixel(p.x_m,p.y_m); if(pp) st.markers.set(d,pp); } draw(); }
setInterval(sync,1000);
</script>
</body>
</html>
